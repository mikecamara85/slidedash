<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>SlideDash – Slideshow Maker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #0b0c10;
        --panel: #12141a;
        --text: #e9eef5;
        --muted: #a8b3c7;
        --accent: #6aa6ff;
        --danger: #ff6a6a;
        --ok: #34d399;
        --border: #202533;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu,
          Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
          "Segoe UI Emoji";
        background: linear-gradient(180deg, #0b0c10, #0f1117);
        color: var(--text);
      }
      .container {
        max-width: 980px;
        margin: 24px auto;
        padding: 0 16px;
      }
      h1 {
        margin: 16px 0;
        font-size: 24px;
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      .row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      @media (min-width: 860px) {
        .row-2 {
          grid-template-columns: 1fr 1fr;
        }
      }
      label {
        font-size: 14px;
        color: var(--muted);
        display: inline-block;
        margin-bottom: 6px;
      }
      input[type="text"],
      input[type="number"],
      textarea,
      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: #0f131a;
        color: var(--text);
        outline: none;
      }
      textarea {
        min-height: 110px;
        resize: vertical;
      }
      .inline {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .tabs {
        display: flex;
        gap: 8px;
      }
      .tab {
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #0f131a;
        color: var(--muted);
      }
      .tab.active {
        background: #121a26;
        color: var(--text);
        border-color: #2a3549;
      }
      .muted {
        color: var(--muted);
        font-size: 13px;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: #1a2332;
        color: var(--text);
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn.primary {
        background: var(--accent);
        border-color: #4e88f0;
        color: #081019;
        font-weight: 600;
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn.danger {
        background: #3a1212;
        border-color: #4a1a1a;
        color: #ffdede;
      }
      .status {
        margin-top: 8px;
        font-size: 14px;
      }
      .ok {
        color: var(--ok);
      }
      .error {
        color: var(--danger);
        white-space: pre-wrap;
      }
      .video-wrap {
        margin-top: 16px;
      }
      video {
        width: 100%;
        border-radius: 12px;
        background: #000;
      }
      .chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
      }
      .chip {
        background: #111723;
        border: 1px solid #223049;
        color: #bcd3ff;
        padding: 6px 10px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 12px;
      }
      .range {
        display: grid;
        grid-template-columns: 100px 1fr 60px;
        gap: 10px;
        align-items: center;
      }
      input[type="range"] {
        width: 100%;
      }
      .footer {
        margin: 24px 0 40px;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }
      .hint {
        font-size: 12px;
        color: var(--muted);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>SlideDash – Slideshow Maker</h1>
      <div class="card">
        <div class="inline">
          <button id="healthBtn" class="btn">Check API</button>
          <div id="healthStatus" class="status muted"></div>
        </div>
        <hr
          style="
            border: none;
            border-top: 1px solid var(--border);
            margin: 12px 0 18px;
          "
        />
        <form id="form">
          <div class="row">
            <div>
              <label for="narration">Narration Text</label>
              <textarea
                id="narration"
                placeholder="Describe your slideshow..."
              ></textarea>
            </div>
          </div>
          <div class="row row-2">
            <div>
              <label for="voice">Voice</label>
              <select id="voice">
                <option>shimmer</option>
                <option>alloy</option>
                <option>echo</option>
                <option>fable</option>
                <option>onyx</option>
                <option>nova</option>
              </select>
            </div>
            <div>
              <label>Speech Rate</label>
              <div class="range">
                <span class="muted">0.5x</span>
                <input
                  id="speechRate"
                  type="range"
                  min="0.5"
                  max="2"
                  step="0.05"
                  value="1"
                />
                <span id="speechRateVal" class="muted">1.00x</span>
              </div>
            </div>
            <div>
              <label>Background Music Volume</label>
              <div class="range">
                <span class="muted">0</span>
                <input
                  id="musicVolume"
                  type="range"
                  min="0"
                  max="1"
                  step="0.05"
                  value="0.2"
                />
                <span id="musicVolumeVal" class="muted">0.20</span>
              </div>
            </div>
            <div class="row row-2" style="grid-column: 1 / -1; gap: 12px">
              <div>
                <label for="width">Width</label>
                <input type="number" id="width" value="1600" />
              </div>
              <div>
                <label for="height">Height</label>
                <input type="number" id="height" value="1200" />
              </div>
            </div>
          </div>
          <hr
            style="
              border: none;
              border-top: 1px solid var(--border);
              margin: 12px 0 18px;
            "
          />
          <div class="tabs">
            <button type="button" class="tab active" data-tab="urls">
              Use URLs
            </button>
            <button type="button" class="tab" data-tab="upload">
              Upload Files
            </button>
          </div>
          <div id="pane-urls" class="pane" style="margin-top: 12px">
            <div class="row">
              <div>
                <label for="imageUrls">Image URLs (one per line)</label>
                <textarea
                  id="imageUrls"
                  placeholder="https://...jpg https://...png"
                ></textarea>
                <div class="hint">
                  Your server will download these images server-side.
                </div>
              </div>
            </div>
            <div class="row row-2">
              <div>
                <label for="bgmUrl">Background Music URL (optional)</label>
                <input type="text" id="bgmUrl" placeholder="https://...mp3" />
              </div>
            </div>
          </div>
          <div
            id="pane-upload"
            class="pane"
            style="display: none; margin-top: 12px"
          >
            <div class="row">
              <div>
                <label for="images">Upload Images</label>
                <input id="images" type="file" accept="image/*" multiple />
                <div class="hint">
                  Limit: up to ~60 files, 30 MB each (server-side limit). For
                  more files, use URLs mode.
                </div>
              </div>
            </div>
            <div class="row row-2">
              <div>
                <label for="bgmFile">Upload Background Music (optional)</label>
                <input id="bgmFile" type="file" accept="audio/*" />
              </div>
            </div>
          </div>
          <div class="chips">
            <span id="prefillBtn" class="chip">Fill with sample data</span>
            <span id="clearBtn" class="chip">Clear</span>
          </div>
          <div class="inline" style="margin-top: 16px; gap: 12px">
            <button id="submitBtn" type="submit" class="btn primary">
              Create Video
            </button>
            <button id="abortBtn" type="button" class="btn danger" disabled>
              Abort
            </button>
            <div id="status" class="status muted">Idle</div>
          </div>
        </form>
        <div id="result" class="video-wrap" style="display: none">
          <video id="video" controls playsinline></video>
          <div class="inline" style="margin-top: 8px">
            <a id="downloadLink" class="btn" download="slideshow.mp4"
              >Download MP4</a
            >
            <span id="sizeInfo" class="muted"></span>
          </div>
        </div>
      </div>
      <div class="footer">
        API: /v1/slideshow (URLs) and /v1/slideshow/upload (multipart uploads).
        TTS runs server-side.
      </div>
    </div>
    <script>
      const API_BASE = window.location.origin;
      const el = (id) => document.getElementById(id);
      const narration = el("narration");
      const voice = el("voice");
      const speechRate = el("speechRate");
      const speechRateVal = el("speechRateVal");
      const musicVolume = el("musicVolume");
      const musicVolumeVal = el("musicVolumeVal");
      const widthEl = el("width");
      const heightEl = el("height");
      const tabs = Array.from(document.querySelectorAll(".tab"));
      const paneUrls = el("pane-urls");
      const paneUpload = el("pane-upload");
      const imageUrls = el("imageUrls");
      const bgmUrl = el("bgmUrl");
      const imagesInput = el("images");
      const bgmFile = el("bgmFile");
      const prefillBtn = el("prefillBtn");
      const clearBtn = el("clearBtn");
      const submitBtn = el("submitBtn");
      const abortBtn = el("abortBtn");
      const statusEl = el("status");
      const resultWrap = el("result");
      const videoEl = el("video");
      const downloadLink = el("downloadLink");
      const sizeInfo = el("sizeInfo");
      const healthBtn = el("healthBtn");
      const healthStatus = el("healthStatus");
      let currentObjectUrl = null;
      let controller = null;
      function setStatus(msg, asError = false) {
        statusEl.textContent = msg;
        statusEl.classList.toggle("error", asError);
        statusEl.classList.toggle("ok", !asError && msg.includes("Ready"));
      }
      function setBusy(isBusy) {
        submitBtn.disabled = isBusy;
        abortBtn.disabled = !isBusy;
      }
      function revokePrevUrl() {
        if (currentObjectUrl) {
          URL.revokeObjectURL(currentObjectUrl);
          currentObjectUrl = null;
        }
      }
      function showResult(blob) {
        revokePrevUrl();
        const url = URL.createObjectURL(blob);
        currentObjectUrl = url;
        videoEl.src = url;
        downloadLink.href = url;
        resultWrap.style.display = "block";
        sizeInfo.textContent = `Size: ${(blob.size / 1024 / 1024).toFixed(
          2
        )} MB`;
      }
      function getActiveMode() {
        return document.querySelector(".tab.active")?.dataset.tab || "urls";
      }
      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          tabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          const mode = getActiveMode();
          paneUrls.style.display = mode === "urls" ? "block" : "none";
          paneUpload.style.display = mode === "upload" ? "block" : "none";
        });
      });
      speechRate.addEventListener("input", () => {
        speechRateVal.textContent = Number(speechRate.value).toFixed(2) + "x";
      });
      musicVolume.addEventListener("input", () => {
        musicVolumeVal.textContent = Number(musicVolume.value).toFixed(2);
      });
      prefillBtn.addEventListener("click", () => {
        narration.value =
          "Welcome to our coastal getaway! First, we arrive at the lighthouse. Next, we explore the rocky shore and seaside town. Finally, we enjoy a beautiful sunset over the water.";
        voice.value = "shimmer";
        speechRate.value = "1.0";
        speechRate.dispatchEvent(new Event("input"));
        musicVolume.value = "0.2";
        musicVolume.dispatchEvent(new Event("input"));
        widthEl.value = 1600;
        heightEl.value = 1200;
        const sample = [
          "https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1600&auto=format&fit=crop",
          "https://images.unsplash.com/photo-1493558103817-58b2924bce98?q=80&w=1600&auto=format&fit=crop",
          "https://images.unsplash.com/photo-1501594907352-04cda38ebc29?q=80&w=1600&auto=format&fit=crop",
          "https://images.unsplash.com/photo-1518837695005-2083093ee35b?q=80&w=1600&auto=format&fit=crop",
        ].join("\n");
        imageUrls.value = sample;
        bgmUrl.value =
          "https://cdn.pixabay.com/download/audio/2022/03/01/audio_703934b53e.mp3?filename=calm-and-peaceful-ambient-141107.mp3";
        setStatus("Sample data filled. Ready to create.");
      });
      clearBtn.addEventListener("click", () => {
        narration.value = "";
        imageUrls.value = "";
        bgmUrl.value = "";
        imagesInput.value = "";
        bgmFile.value = "";
        setStatus("Cleared.");
      });
      healthBtn.addEventListener("click", async () => {
        healthStatus.textContent = "Checking...";
        try {
          const r = await fetch(`${API_BASE}/health`, { method: "GET" });
          const j = await r.json();
          healthStatus.textContent = j.ok ? "API OK" : "API not healthy";
          healthStatus.classList.toggle("ok", !!j.ok);
        } catch (e) {
          healthStatus.textContent = "Failed to reach API";
        }
      });
      abortBtn.addEventListener("click", () => {
        if (controller) controller.abort();
      });
      async function requestViaUrls(payload) {
        controller = new AbortController();
        const r = await fetch(`${API_BASE}/v1/slideshow`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          signal: controller.signal,
          body: JSON.stringify(payload),
        });
        if (!r.ok) {
          try {
            const err = await r.json();
            throw new Error(err?.error || `Server returned ${r.status}`);
          } catch {
            const text = await r.text();
            throw new Error(text || `Server returned ${r.status}`);
          }
        }
        return await r.blob();
      }
      async function requestViaUpload(fields, files) {
        controller = new AbortController();
        const fd = new FormData();
        fd.append("narrationText", fields.narrationText);
        fd.append("width", String(fields.width));
        fd.append("height", String(fields.height));
        fd.append("voice", fields.voice);
        fd.append("musicVolume", String(fields.musicVolume));
        fd.append("speechRate", String(fields.speechRate));
        for (const f of files.images) fd.append("images", f, f.name);
        if (files.bgm) fd.append("bgm", files.bgm, files.bgm.name);
        const r = await fetch(`${API_BASE}/v1/slideshow/upload`, {
          method: "POST",
          body: fd,
          signal: controller.signal,
        });
        if (!r.ok) {
          try {
            const err = await r.json();
            throw new Error(err?.error || `Server returned ${r.status}`);
          } catch {
            const text = await r.text();
            throw new Error(text || `Server returned ${r.status}`);
          }
        }
        return await r.blob();
      }
      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();
        resultWrap.style.display = "none";
        setBusy(true);
        setStatus("Uploading/processing... this can take a minute.");
        try {
          const base = {
            narrationText: narration.value.trim(),
            width: Number(widthEl.value || 1600),
            height: Number(heightEl.value || 1200),
            voice: voice.value,
            musicVolume: Number(musicVolume.value),
            speechRate: Number(speechRate.value),
          };
          if (!base.narrationText) {
            throw new Error("Please enter narration text.");
          }
          const mode = getActiveMode();
          let blob;
          if (mode === "urls") {
            const urls = imageUrls.value
              .split(/\r?\n/)
              .map((s) => s.trim())
              .filter(Boolean);
            if (!urls.length)
              throw new Error("Please add at least one image URL.");
            const payload = {
              ...base,
              narrationText: base.narrationText,
              imageUrls: urls,
            };
            const bgm = bgmUrl.value.trim();
            if (bgm) payload.backgroundMusicUrl = bgm;
            blob = await requestViaUrls(payload);
          } else {
            const imgs = Array.from(imagesInput.files || []);
            if (!imgs.length)
              throw new Error("Please select at least one image file.");
            const files = { images: imgs, bgm: bgmFile.files?.[0] || null };
            blob = await requestViaUpload(base, files);
          }
          showResult(blob);
          setStatus("Ready. Video created.", false);
        } catch (err) {
          const msg = err?.message || String(err);
          setStatus("Error: " + msg, true);
        } finally {
          setBusy(false);
          controller = null;
        }
      });
    </script>
  </body>
</html>
